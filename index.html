<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Operations Center Checklist</title>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    
    // TODO: Replace with your Firebase config
    const firebaseConfig = {
     apiKey: "AIzaSyC7qDBxgDgLAZAaNDH5X1cCAVmwshQWml4",
  authDomain: "to-do-list-dfa40.firebaseapp.com",
  databaseURL: "https://to-do-list-dfa40-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "to-do-list-dfa40",
  storageBucket: "to-do-list-dfa40.firebasestorage.app",
  messagingSenderId: "1026658012382",
  appId: "1:1026658012382:web:30d662f7f63cbed723864f",
  measurementId: "G-TW5MKN63SV"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    
    // Make Firebase available globally
    window.firebase = { database, ref, set, get, onValue, push, remove, update };
  </script>

  <!-- External Libraries -->
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

  <style>
   /* ———————————————————————————————————————————————————————————————
       Updated Color Palette
       • Day Shift: Warm Amber
       • Night Shift: Deep Indigo
       • Primary / Accent adjusted for cohesion
       ——————————————————————————————————————————————————————————————— */
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #4b5563;
      --border: #e5e7eb;
      --shadow: 0 4px 12px rgba(0,0,0,0.05);

      /* primary brand tones */
      --primary: #0288d1;        /* Cerulean blue */
      --accent: #26c6da;         /* Teal accent */

      /* shifts */
      --day-accent: #ffc107;     /* Amber */
      --night-accent: #3f51b5;   /* Indigo */

      /* utility */
      --success: #16a34a;
      --warning: #f97316;
      --danger: #dc2626;

      --chip-bg: #f1f5f9;
      --chip-text: #1f2937;
      --radius: 10px;
    }
    [data-theme="dark"] {
      --bg: #1e293b;
      --card: #334155;
      --text: #f1f5f9;
      --muted: #9ca3af;
      --border: #475569;
      --shadow: 0 4px 12px rgba(0,0,0,0.6);

      --chip-bg: #475569;
      --chip-text: #f1f5f9;
    }

    /* — Reset & Body — */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* — Header — */
    .app-header {
      position: sticky; top: 0;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      box-shadow: var(--shadow);
      z-index: 10;
    }
    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex; justify-content: space-between; align-items: center;
    }
    .brand { font-weight: 700; font-size: 20px; }
    .theme-toggle {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .theme-toggle:hover {
      background: var(--primary);
      color: #fff;
    }

    /* — Toasts — */
    .toast-wrap {
      position: fixed; top: 16px; right: 16px;
      display: grid; gap: 10px; z-index: 30;
    }
    .toast {
      display: flex; align-items: center; gap: 8px;
      padding: 10px 14px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-left-width: 4px;
      opacity: 1; animation: slideIn 0.2s ease forwards;
      min-width: 240px;
    }
    .toast.success { border-left-color: var(--success); }
    .toast.info    { border-left-color: var(--primary); }
    .toast.error   { border-left-color: var(--danger); }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* — Alarm Notification — */
    .alarm-notification {
      position: fixed; bottom: 24px; right: 24px;
      background: var(--danger); color: #fff;
      padding: 14px 16px; border-radius: var(--radius);
      box-shadow: var(--shadow); display: none;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50%     { transform: scale(1.05); }
    }
    .alarm-notification button {
      margin-top: 8px;
      background: #fff; color: var(--danger);
      border: none; padding: 6px 10px;
      border-radius: 999px; cursor: pointer;
      font-weight: 600;
    }

    /* — Page & Title — */
    .page {
      max-width: 1100px;
      margin: 32px auto 120px; padding: 0 16px;
    }
    .title-card {
      background: var(--card);
      background-image: linear-gradient(135deg, var(--card) 0%, rgba(38,198,218,0.04) 100%);
      border: 1px solid var(--border);
      border-left: 6px solid var(--accent);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px; text-align: center;
      margin-bottom: 24px;
    }
    .report-title { font-size: 24px; font-weight: 700; }
    .report-date  { font-size: 14px; color: var(--muted); }

    /* — Tabs — */
    .shift-tabs {
      display: flex; justify-content: center; gap: 12px; margin-top: 20px;
    }
    .shift-tab {
      position: relative;
      padding: 10px 20px;
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: var(--radius) var(--radius) 0 0;
      background: var(--card);
      color: var(--muted);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .shift-tab.day::before,
    .shift-tab.night::before {
      content: "";
      position: absolute; top: 10px; left: 8px;
      width: 8px; height: 8px; border-radius: 50%;
    }
    .shift-tab.day::before   { background: var(--day-accent); }
    .shift-tab.night::before { background: var(--night-accent); }
    .shift-tab:hover {
      background: rgba(38,198,218,0.1);
      color: var(--text);
    }
    .shift-tab.active {
      background: var(--card);
      color: var(--text);
      border-color: var(--border);
      border-bottom: 1px solid var(--card);
    }

    /* — Shift Containers — */
    .shift-container {
      display: none;
      background: var(--card);
      background-image: linear-gradient(135deg, var(--card) 0%, rgba(38,198,218,0.04) 100%);
      border: 1px solid var(--border);
      border-radius: 0 var(--radius) var(--radius) var(--radius);
      padding: 24px; box-shadow: var(--shadow);
      animation: slideDown 0.25s ease both;
    }
    .shift-container.active { display: block; }
    .shift-container.day-shift   { border-top: 6px solid var(--day-accent); }
    .shift-container.night-shift { border-top: 6px solid var(--night-accent); }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .shift-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 20px;
    }
    .shift-header h2 { font-size: 20px; font-weight: 700; margin: 0; }

    .progress {
      display: flex; align-items: center; gap: 10px;
    }
    .progress-bar {
      position: relative;
      width: 240px; height: 8px;
      background: rgba(107,114,128,0.2);
      border-radius: 999px; overflow: hidden;
    }
    .progress-fill {
      position: absolute; inset: 0;
      width: 0%; background: var(--accent);
      border-radius: 999px;
      transition: width 0.8s ease-out;
    }
    .progress-label {
      width: 32px; text-align: right;
      font-size: 12px; color: var(--muted);
    }

    /* — Task List — */
    .task-list {
      list-style: none; padding: 0; margin: 0;
      display: grid; gap: 12px;
    }
    .task-item {
      display: grid;
      grid-template-columns: 120px 1fr 140px auto;
      align-items: center; gap: 12px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #f9fafb;
      cursor: grab;
      animation: fadeIn 0.3s ease both;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .task-item:hover {
      background: rgba(255,193,7,0.1);
      box-shadow: var(--shadow);
    }
    .task-item.night-hover:hover {
      background: rgba(63,81,181,0.1);
    }
    /* Completed & Upcoming */
    .task-item.completed { background: rgba(22,163,74,0.1); }
    .task-item.upcoming  { border-color: var(--warning); background: rgba(249,115,22,0.1); }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .task-time,
    .task-assignee {
      font-size: 14px; font-weight: 500;
      background: var(--chip-bg); color: var(--chip-text);
      border: 1px solid var(--border);
      padding: 6px 10px; border-radius: 999px;
      text-align: center; white-space: nowrap;
    }
    .task-text {
      font-size: 14px; color: var(--text); word-break: break-word;
    }

    .task-actions {
      display: inline-flex; gap: 6px;
    }
    .btn-icon {
      width: 32px; height: 32px;
      display: inline-grid; place-items: center;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .btn-icon:hover {
      background: var(--accent); color: #fff; box-shadow: var(--shadow);
    }
    .btn-complete { color: var(--success); }
    .btn-edit     { color: var(--warning); }
    .btn-delete   { color: var(--danger); }

    /* — Add Task Form — */
    .add-task-form {
      margin-top: 24px;
      display: grid;
      grid-template-columns: 200px 1fr 200px auto;
      gap: 12px; padding: 16px;
      border: 1px dashed var(--border);
      border-radius: var(--radius);
      background: rgba(38,198,218,0.05);
    }
    .add-task-form input,
    .add-task-form select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--text);
    }
    .add-btn {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .add-btn:hover { background: var(--accent); }
    .error-message {
      color: var(--danger); font-size: 12px; display: none;
    }
    .error-border { border-color: var(--danger) !important; }

    /* — Remarks — */
    .remarks-section {
      margin-top: 24px;
      padding: 16px;
      border-left: 4px solid var(--accent);
      background: rgba(38,198,218,0.05);
      border-radius: var(--radius);
    }
    .remarks-section textarea {
      width: 100%; min-height: 100px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--text);
      resize: vertical;
    }

    /* — Action Bar — */
    .action-bar {
      position: fixed; bottom: 16px; left: 50%;
      transform: translateX(-50%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow);
      padding: 8px; display: flex; gap: 12px;
      z-index: 20;
    }
    .action-bar .btn {
      padding: 10px 16px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
    }
    .action-bar .btn:hover {
      background: var(--accent); color: #fff;
    }
    .btn.save  { background: var(--accent); color: #fff; border-color: transparent; }
    .btn.clear { color: var(--danger); }
    .btn.excel { background: var(--success); color: #fff; border-color: transparent; }

    /* — Modal — */
    .modal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);
      padding: 20px; z-index: 40;
    }
    .modal-content {
      max-width: 500px; margin: 8vh auto;
      background: var(--card); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow: hidden;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px; border-bottom: 1px solid var(--border);
    }
    .modal-title { font-weight: 700; }
    .close-btn {
      font-size: 20px; cursor: pointer; color: var(--muted);
    }
    .modal-body {
      padding: 16px; display: grid; gap: 12px;
    }
    .form-group label {
      display: block; font-weight: 600; margin-bottom: 6px;
    }
    .form-group input,
    .form-group select {
      width: 100%; padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--text);
    }
    .modal-footer {
      display: flex; justify-content: flex-end; gap: 8px;
      padding: 14px 18px; border-top: 1px solid var(--border);
    }
    .modal-btn {
      padding: 8px 16px; border: 1px solid var(--border);
      background: var(--card); cursor: pointer;
      border-radius: var(--radius); font-weight: 600;
      transition: background 0.2s, color 0.2s;
    }
    .modal-btn:hover {
      background: var(--accent); color: #fff;
    }
    .modal-btn-primary {
      background: var(--accent); color: #fff; border-color: transparent;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="app-header">
    <div class="header-inner">
      <div class="brand">Operations Center</div>
      <div style="display: flex; gap: 12px; align-items: center;">
        <div class="status-indicator">
          <span class="status-dot" id="connectionStatus"></span>
          <span id="connectionText">Connecting...</span>
        </div>
        <button id="themeToggle" class="theme-toggle">Toggle Theme</button>
      </div>
    </div>
  </header>

  <!-- TOASTS -->
  <div id="toastWrap" class="toast-wrap"></div>

  <!-- ALARM -->
  <div id="alarmNotification" class="alarm-notification">
    <div><strong>Upcoming Task</strong></div>
    <div id="alarmMessage" style="margin-top:8px;"></div>
    <button onclick="closeAlarm()">Dismiss</button>
  </div>

  <!-- MAIN CONTENT -->
  <main class="page">
    <div id="checklist-content">
      <div class="title-card">
        <div class="report-title">Operations Center Checklist</div>
        <div class="report-date">Stay focused. Stay efficient.</div>
        <div class="shift-tabs">
          <div class="shift-tab day active" onclick="showShift('day')">Day Shift</div>
          <div class="shift-tab night" onclick="showShift('night')">Night Shift</div>
        </div>
      </div>

      <!-- DAY SHIFT -->
      <div id="day-shift-container" class="shift-container day-shift active">
        <div class="shift-header">
          <h2>Day Shift</h2>
          <div class="progress">
            <span id="day-progress-label" class="progress-label">0%</span>
            <div class="progress-bar">
              <div id="day-progress" class="progress-fill"></div>
            </div>
          </div>
        </div>
        <ul id="day-shift-tasks" class="task-list"></ul>

        <div class="add-task-form">
          <input type="datetime-local" id="day-shift-new-time" required />
          <input type="text" id="day-shift-new-task" placeholder="Task description" required />
          <select id="day-shift-new-assignee" class="assignee-select" required>
            <option value="">Select Assignee</option>
          </select>
          <button class="add-btn" onclick="addTask('day')">Add Task</button>
          <div id="day-shift-assignee-error" class="error-message">
            Please select an assignee
          </div>
        </div>

        <div class="remarks-section">
          <textarea id="day-shift-remarks" placeholder="Enter remarks..." onblur="saveRemarks('day')"></textarea>
        </div>
      </div>

      <!-- NIGHT SHIFT -->
      <div id="night-shift-container" class="shift-container night-shift">
        <div class="shift-header">
          <h2>Night Shift</h2>
          <div class="progress">
            <span id="night-progress-label" class="progress-label">0%</span>
            <div class="progress-bar">
              <div id="night-progress" class="progress-fill"></div>
            </div>
          </div>
        </div>
        <ul id="night-shift-tasks" class="task-list"></ul>

        <div class="add-task-form">
          <input type="datetime-local" id="night-shift-new-time" required />
          <input type="text" id="night-shift-new-task" placeholder="Task description" required />
          <select id="night-shift-new-assignee" class="assignee-select" required>
            <option value="">Select Assignee</option>
          </select>
          <button class="add-btn" onclick="addTask('night')">Add Task</button>
          <div id="night-shift-assignee-error" class="error-message">
            Please select an assignee
          </div>
        </div>

        <div class="remarks-section">
          <textarea id="night-shift-remarks" placeholder="Enter remarks..." onblur="saveRemarks('night')"></textarea>
        </div>
      </div>
    </div>
  </main>

  <!-- ACTION BAR -->
  <div class="action-bar">
    <button class="btn" onclick="syncData()">Sync Now</button>
    <button class="btn sort" onclick="sortTasks()">Sort by Time</button>
    <button class="btn clear" onclick="clearAllTasks()">Clear All Tasks</button>
    <button class="btn" onclick="downloadChecklist('day')">Download Day Shift</button>
    <button class="btn" onclick="downloadChecklist('night')">Download Night Shift</button>
    <button class="btn excel" onclick="exportToExcel()">Export to Excel</button>
  </div>

  <!-- EDIT TASK MODAL -->
  <div id="editTaskModal" class="modal" role="dialog" aria-modal="true">
    <div class="modal-content">
      <div class="modal-header">
        <span class="modal-title">Edit Task</span>
        <span class="close-btn" onclick="closeEditModal()">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="edit-task-time">Time</label>
          <input type="datetime-local" id="edit-task-time" required />
        </div>
        <div class="form-group">
          <label for="edit-task-text">Task Description</label>
          <input type="text" id="edit-task-text" required />
        </div>
        <div class="form-group">
          <label for="edit-task-assignee">Assignee</label>
          <select id="edit-task-assignee" required>
            <option value="">Select Assignee</option>
          </select>
          <div id="edit-task-assignee-error" class="error-message">
            Please select an assignee
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn" id="cancel-edit-btn">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="save-edit-btn">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // ─────────────────────────────────────────────────────────────────────────
    // FIREBASE INTEGRATION
    // ─────────────────────────────────────────────────────────────────────────

    const assignees = [
      "Geron","John Mick","Nelson","Jeremiah",
      "Anna","Judy","Joyce","Ceriaco",
      "Jonnie","Danica","Jake","Joseph"
    ].sort(() => Math.random() - 0.5);

    const dayTasksEl   = document.getElementById('day-shift-tasks');
    const nightTasksEl = document.getElementById('night-shift-tasks');
    const modal        = document.getElementById('editTaskModal');
    let currentEditShift = '', currentEditIndex = -1;
    let tasks = { day: [], night: [] };
    let remarks = { day: '', night: '' };
    let isConnected = false;

    // Firebase references
    let tasksRef, remarksRef;

    window.onload = async () => {
      initTheme();
      populateAssignees();
      await initFirebase();
      bindEditModal();
      startAlarmChecker();
    };

    async function initFirebase() {
      try {
        const { database, ref, onValue } = window.firebase;
        
        // Initialize references
        tasksRef = ref(database, 'shiftTasks');
        remarksRef = ref(database, 'shiftRemarks');
        
        // Listen for connection status
        const connectedRef = ref(database, '.info/connected');
        onValue(connectedRef, (snapshot) => {
          isConnected = snapshot.val() === true;
          updateConnectionStatus();
        });

        // Listen for tasks changes
        onValue(tasksRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            tasks = { day: data.day || [], night: data.night || [] };
            adjustDates();
            renderTasks();
          }
        });

        // Listen for remarks changes
        onValue(remarksRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            remarks = data;
            document.getElementById('day-shift-remarks').value = remarks.day || '';
            document.getElementById('night-shift-remarks').value = remarks.night || '';
          }
        });

        showToast('Connected to Firebase', 'success');
      } catch (error) {
        console.error('Firebase initialization failed:', error);
        showToast('Firebase connection failed. Check your config.', 'error');
        // Fall back to localStorage
        loadFromLocalStorage();
      }
    }

    function updateConnectionStatus() {
      const statusDot = document.getElementById('connectionStatus');
      const statusText = document.getElementById('connectionText');
      
      if (isConnected) {
        statusDot.classList.add('connected');
        statusText.textContent = 'Connected';
      } else {
        statusDot.classList.remove('connected');
        statusText.textContent = 'Offline';
      }
    }

    async function saveTasksToFirebase() {
      if (!isConnected || !window.firebase) {
        showToast('Saving locally - no connection', 'info');
        localStorage.setItem('shiftTasks', JSON.stringify(tasks));
        return;
      }

      try {
        const { set } = window.firebase;
        await set(tasksRef, tasks);
        showToast('Tasks synced to cloud', 'success');
      } catch (error) {
        console.error('Failed to save to Firebase:', error);
        showToast('Failed to sync - saved locally', 'error');
        localStorage.setItem('shiftTasks', JSON.stringify(tasks));
      }
    }

    async function saveRemarks(shift) {
      const value = document.getElementById(`${shift}-shift-remarks`).value;
      remarks[shift] = value;

      if (!isConnected || !window.firebase) {
        localStorage.setItem('shiftRemarks', JSON.stringify(remarks));
        return;
      }

      try {
        const { set } = window.firebase;
        await set(remarksRef, remarks);
      } catch (error) {
        console.error('Failed to save remarks:', error);
        localStorage.setItem('shiftRemarks', JSON.stringify(remarks));
      }
    }

    function loadFromLocalStorage() {
      const savedTasks = localStorage.getItem('shiftTasks');
      if (savedTasks) tasks = JSON.parse(savedTasks);
      
      const savedRemarks = localStorage.getItem('shiftRemarks');
      if (savedRemarks) {
        remarks = JSON.parse(savedRemarks);
        document.getElementById('day-shift-remarks').value = remarks.day || '';
        document.getElementById('night-shift-remarks').value = remarks.night || '';
      }
      
      adjustDates();
      renderTasks();
    }

    async function syncData() {
      if (!isConnected) {
        showToast('No internet connection', 'error');
        return;
      }
      
      try {
        await saveTasksToFirebase();
        showToast('Data synchronized', 'success');
      } catch (error) {
        showToast('Sync failed', 'error');
      }
    }

    // ─────────────────────────────────────────────────────────────────────────
    // EXISTING APPLICATION LOGIC (Updated for Firebase)
    // ─────────────────────────────────────────────────────────────────────────

    function initTheme() {
      const btn  = document.getElementById('themeToggle');
      const root = document.documentElement;
      const saved = localStorage.getItem('theme') || 'light';
      root.setAttribute('data-theme', saved);
      btn.onclick = () => {
        const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      };
    }

    function populateAssignees() {
      document.querySelectorAll('.assignee-select, #edit-task-assignee')
        .forEach(select => {
          while (select.options.length > 1) select.remove(1);
          assignees.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name; opt.textContent = name;
            select.appendChild(opt);
          });
        });
    }

    function adjustDates() {
      const now = new Date();
      ['day','night'].forEach(s => {
        tasks[s].forEach(t => {
          const d = new Date(t.time);
          d.setFullYear(now.getFullYear(), now.getMonth(), now.getDate());
          t.time = d.toISOString().slice(0,16);
        });
        document.getElementById(`${s}-shift-new-time`).value = now.toISOString().slice(0,16);
      });
    }

    function renderTasks() {
      renderShift('day');
      renderShift('night');
      setupDragAndDrop();
    }

    function renderShift(shift) {
      const list = shift==='day'? dayTasksEl : nightTasksEl;
      list.innerHTML = '';
      tasks[shift].forEach((t,i) => {
        const li = document.createElement('li');
        li.className = `task-item${t.completed?' completed':''}`;
        li.draggable = true;
        li.dataset.shift = shift;
        li.dataset.index = i;
        li.innerHTML = `
          <span class="task-time">${formatDisplay(t.time)}</span>
          <span class="task-text">${t.text}</span>
          <span class="task-assignee">${t.assignee}</span>
          <div class="task-actions">
            <button class="btn-icon btn-complete" onclick="toggleComplete('${shift}',${i})">✓</button>
            <button class="btn-icon btn-edit"     onclick="openEditModal('${shift}',${i})">✎</button>
            <button class="btn-icon btn-delete"   onclick="deleteTask('${shift}',${i})">✕</button>
          </div>`;
        list.appendChild(li);
      });
      updateProgress(shift);
    }

    function updateProgress(shift) {
      const done = tasks[shift].filter(t=>t.completed).length;
      const pct  = tasks[shift].length? Math.round(done/tasks[shift].length*100):0;
      document.getElementById(`${shift}-progress`).style.width = pct+'%';
      document.getElementById(`${shift}-progress-label`).textContent = pct+'%';
    }

    async function addTask(shift) {
      const tm = document.getElementById(`${shift}-shift-new-time`);
      const tx = document.getElementById(`${shift}-shift-new-task`);
      const sel= document.getElementById(`${shift}-shift-new-assignee`);
      const err= document.getElementById(`${shift}-shift-assignee-error`);
      
      sel.classList.remove('error-border'); 
      err.style.display='none';
      
      if (!tm.value||!tx.value) { 
        showToast('Enter time & description','error'); 
        return; 
      }
      if (!sel.value) {
        sel.classList.add('error-border');
        err.style.display='block';
        showToast('Select assignee','error');
        return;
      }
      
      const newTask = {
        time: tm.value, 
        text: tx.value, 
        assignee: sel.value, 
        completed: false,
        id: Date.now().toString() // Add unique ID for Firebase
      };
      
      tasks[shift].push(newTask);
      
      tm.value = new Date().toISOString().slice(0,16);
      tx.value = ''; 
      sel.value = '';
      
      renderTasks(); 
      await saveTasksToFirebase();
      showToast('Task added','success');
    }

    async function toggleComplete(s,i) {
      tasks[s][i].completed = !tasks[s][i].completed;
      renderTasks();
      await saveTasksToFirebase();
    }

    async function deleteTask(s,i) {
      if (!confirm('Delete this task?')) return;
      tasks[s].splice(i,1);
      renderTasks(); 
      await saveTasksToFirebase();
      showToast('Task deleted','info');
    }

    async function sortTasks() {
      ['day','night'].forEach(s => {
        tasks[s].sort((a,b)=> new Date(a.time)-new Date(b.time));
      });
      renderTasks(); 
      await saveTasksToFirebase();
      showToast('Tasks sorted','info');
    }

    async function clearAllTasks() {
      if (!confirm('Clear all tasks and remarks?')) return;
      tasks.day=[]; 
      tasks.night=[];
      remarks={day:'',night:''};
      document.getElementById('day-shift-remarks').value='';
      document.getElementById('night-shift-remarks').value='';
      renderTasks(); 
      await saveTasksToFirebase();
      await saveRemarks('day');
      await saveRemarks('night');
      showToast('All data cleared','info');
    }

    function bindEditModal() {
      document.getElementById('cancel-edit-btn').onclick = closeEditModal;
      document.getElementById('save-edit-btn').onclick   = saveEdit;
      modal.onclick = e => { if (e.target===modal) closeEditModal(); };
    }

    function openEditModal(shift,i) {
      currentEditShift = shift; 
      currentEditIndex = i;
      const t = tasks[shift][i];
      document.getElementById('edit-task-time').value     = t.time;
      document.getElementById('edit-task-text').value     = t.text;
      document.getElementById('edit-task-assignee').value = t.assignee;
      document.getElementById('edit-task-assignee').classList.remove('error-border');
      document.getElementById('edit-task-assignee-error').style.display='none';
      modal.style.display='block';
    }

    async function saveEdit() {
      const tm = document.getElementById('edit-task-time');
      const tx = document.getElementById('edit-task-text');
      const sel= document.getElementById('edit-task-assignee');
      const err= document.getElementById('edit-task-assignee-error');
      
      sel.classList.remove('error-border'); 
      err.style.display='none';
      
      if (!tm.value||!tx.value) { 
        showToast('Enter time & description','error'); 
        return; 
      }
      if (!sel.value) {
        sel.classList.add('error-border');
        err.style.display='block';
        showToast('Select assignee','error');
        return;
      }
      
      const t = tasks[currentEditShift][currentEditIndex];
      t.time = tm.value; 
      t.text = tx.value; 
      t.assignee = sel.value;
      
      closeEditModal(); 
      renderTasks(); 
      await saveTasksToFirebase();
      showToast('Task updated','success');
    }

    function closeEditModal() { 
      modal.style.display='none'; 
    }

    function downloadChecklist(shift) {
      const hdr = document.querySelector('.app-header');
      const bar = document.querySelector('.action-bar');
      hdr.style.display='none'; 
      bar.style.display='none';
      showShift(shift);
      
      html2canvas(document.getElementById('checklist-content'), {
        scale: window.devicePixelRatio*2,
        useCORS: true,
        backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg').trim()
      }).then(canvas=>{
        const link=document.createElement('a');
        link.download=`${shift}-shift-${new Date().toISOString().slice(0,10)}.png`;
        link.href=canvas.toDataURL('image/png');
        link.click();
        showToast(`${shift} shift downloaded`, 'success');
      }).finally(()=>{
        hdr.style.display=''; 
        bar.style.display='';
        showShift('day');
      });
    }

    async function exportToExcel() {
      try {
        const wb=new ExcelJS.Workbook();
        wb.creator='Ops Center'; 
        wb.created=new Date();
        
        function createSheet(name,data,rem) {
          const ws=wb.addWorksheet(`${name} Shift`);
          ws.mergeCells('A1:E1');
          ws.getCell('A1').value=`${name.toUpperCase()} SHIFT CHECKLIST`;
          ws.getCell('A1').font={bold:true,size:14};
          ws.mergeCells('A2:B2');
          ws.getCell('A2').value=`Date: ${new Date().toLocaleDateString()}`;
          
          const hdr=['Time','Description','Assignee','Status','Notes'];
          const hr=ws.addRow(hdr);
          hr.font={bold:true};
          hr.eachCell(c=>{
            c.fill={type:'pattern',pattern:'solid',fgColor:{argb:'FFD3D3D3'}};
            c.border={top:{style:'thin'},left:{style:'thin'},bottom:{style:'thin'}, right:{style:'thin'}};
            c.alignment={horizontal:'center'};
          });
          
          data.forEach(t=>{
            const row=ws.addRow([
              formatExcel(t.time),t.text,t.assignee,
              t.completed?'Completed':'Pending',''
            ]);
            if(t.completed) row.eachCell(c=>c.font={color:{argb:'FF16A34A'}});
          });
          
          ws.addRow([]); 
          ws.addRow(['Remarks:',rem]);
          ws.columns=[{width:20},{width:40},{width:20},{width:12},{width:30}];
        }
        
        createSheet('Day', tasks.day, remarks.day);
        createSheet('Night', tasks.night, remarks.night);
        
        const buf=await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf],{type:'application/octet-stream'}),
          `Shift_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
        showToast('Excel exported','success');
      } catch (error) {
        console.error('Excel export failed:', error);
        showToast('Excel export failed','error');
      }
    }

    function showShift(shift) {
      document.querySelectorAll('.shift-tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.shift-container').forEach(c=>c.classList.remove('active'));
      document.querySelector(`.shift-tab.${shift}`).classList.add('active');
      document.getElementById(`${shift}-shift-container`).classList.add('active');
    }

    function setupDragAndDrop() {
      let draggedItem, draggedShift, draggedIndex;
      document.querySelectorAll('.task-item').forEach(item=>{
        item.addEventListener('dragstart',e=>{
          draggedItem=item;
          draggedShift=item.dataset.shift;
          draggedIndex=+item.dataset.index;
          item.classList.add('dragging');
        });
        item.addEventListener('dragend',()=>{
          item.classList.remove('dragging');
          saveTasksToFirebase(); // Save after drag
        });
        item.addEventListener('dragover',e=>e.preventDefault());
        item.addEventListener('drop',()=>{
          const ts=item.dataset.shift;
          const ti=+item.dataset.index;
          if(draggedItem&&ts===draggedShift){
            const [m]=tasks[draggedShift].splice(draggedIndex,1);
            tasks[draggedShift].splice(ti,0,m);
            renderTasks();
          }
        });
      });
    }

    function startAlarmChecker(){
      setInterval(checkAlarms,30000);
      checkAlarms();
    }
    
    function checkAlarms(){
      const now=Date.now(), list=[];
      ['day','night'].forEach(s=>{
        tasks[s].forEach(t=>{
          if(!t.completed){
            const d=new Date(t.time).getTime()-now;
            if(d>-60000&&d<300000) list.push({s,t,d});
          }
        });
      });
      list.sort((a,b)=>a.d-b.d);
      document.querySelectorAll('.task-item.upcoming').forEach(el=>el.classList.remove('upcoming'));
      if(list.length){
        const {s,t}=list[0];
        const idx=tasks[s].indexOf(t);
        const el=document.querySelector(`#${s}-shift-tasks .task-item[data-index="${idx}"]`);
        if(el) el.classList.add('upcoming');
        showAlarm(s,t);
      } else closeAlarm();
    }
    
    function showAlarm(shift,task){
      const box=document.getElementById('alarmNotification');
      document.getElementById('alarmMessage').textContent = 
        `${formatDisplay(task.time)} – ${task.text}`;
      box.style.display='block';
    }
    
    function closeAlarm(){ 
      document.getElementById('alarmNotification').style.display='none'; 
    }

    function formatDisplay(dt){
      const d=new Date(dt);
      return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    }
    
    function formatExcel(dt){
      const d=new Date(dt);
      return `${d.toLocaleDateString()} ${d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
    }

    function showToast(msg, type='info'){
      const wrap=document.getElementById('toastWrap');
      const el=document.createElement('div');
      el.className=`toast ${type}`;
      el.textContent=msg;
      wrap.appendChild(el);
      setTimeout(()=>el.remove(),3000);
    }
  </script>
</body>
</html>
